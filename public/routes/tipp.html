<!doctype html>
<html>
  <head>
    <title>WM Tippspiel</title>
	<style>
      * { margin: 0; padding: 0; box-sizing: border-box; font-size:16px;}
      body {  font: 24px Helvetica, Arial; display:flex; flex-direction: column;}
	  html, body{
		height: 100%;
	  }
	  #wrapper div, iframe {float: left;}
	  .flex-container {
		display: flex;
		flex-direction: column;
	  }
	  #contentWrapper {
		min-height:100%;
		position:relative;
		background-size:cover;
		background-image: url('/images/back3.jpg');
	  }
	  #votes {
		width:70%;
		border-style: solid;
	  }
	  #points {
		width:30%;
		border-style: solid;
	  }
	  .backgroundTop {
		background-size:cover;
		background-image: url('/images/top3.jpg');
	  }
	  .btn-group input[type="radio"] {
		display: none;
	  }
	  .btn-group label { 
		background: #D3D3D3;
		font-size:24px;
		padding:5px;
		border-radius: 6px;
		width: 200px;
		display: inline-block;
		border: 2px solid #4CAF50;
	  }
	  .btn-group input[type="number"] {
		font-size:24px;
		padding:5px;
		border-radius: 6px;
		border: 2px solid #4CAF50;
		width: 100px;
	  }
	  .btn-group input[type="radio"]:checked+label{
		color: white;
		background-color: #4CAF50;
	  }
	  .btn-group input[type="submit"] {
	    font-size:24px;
		padding:5px;
		border-radius: 6px;
		border: 2px solid #008CBA; 
		width: 100px;
	  }
	  .btn-group input[type="submit"]:hover:enabled {
		background-color: #008CBA; 
		color:white; 
		cursor:pointer;
	  }
	  
	  form {
		padding:10px;
	  }
    </style>
	<script type="application/x-javascript"> addEventListener("load", function() { setTimeout(hideURLbar, 0); }, false); function hideURLbar(){ window.scrollTo(0,1); } </script>
</head>
  <body >
		<div id="contentWrapper">
			<div class="backgroundTop" style="font-size:24px; padding:5px">
				<a href="/" style="text-decoration: none; margin-right: 20px;">
					<img id="icon" src="/images/teewurst_icon_white.ico" alt="Icon" style="width:32px;height:32px;">
				</a>
				<span style="color:white;font-size:24px">Tippspiel</span>
				<label style="color:white;font-size:20px;margin-left: 100px;" id="pointView">Chips:</label>
			</div>
			<div class="flex-container">
				<div class="backgroundMain" id="wrapper">
					<br>
					<div id="votes">
						<div class="tipp-form">
							<form id="Russia_Croatia">
								<div class="btn-group">
								  <input type="radio" id="radio1_10" name="radios" value="0">
								  <label for="radio1_10">Russia<br><font size="6">3,7</font></label>

								  <input type="radio" id="radio2_10" name="radios" value="1">
								  <label for="radio2_10">~<br><font size="6">3,1</font></label>

								  <input type="radio" id="radio3_10" name="radios" value="2">
								  <label for="radio3_10">Croatia<br><font size="6">2,2</font></label>
								  
								  <input type="number" name="pointInput" placeholder="0">
								  <input type="submit" value="SAVE">
								</div>	
							</form>
						</div>
						<div class="tipp-form">
							<form id="Sweden_England">
								<div class="btn-group">
								  <input type="radio" id="radio1_9" name="radios" value="0">
								  <label for="radio1_9">Sweden<br><font size="6">4,7</font></label>

								  <input type="radio" id="radio2_9" name="radios" value="1">
								  <label for="radio2_9">~<br><font size="6">3,2</font></label>

								  <input type="radio" id="radio3_9" name="radios" value="2">
								  <label for="radio3_9">England<br><font size="6">1,9</font></label>
								  
								  <input type="number" name="pointInput" placeholder="0">
								  <input type="submit" value="SAVE">
								</div>	
							</form>
						</div>
						<div class="tipp-form">
							<form id="Brazil_Belgium">
								<div class="btn-group">
								  <input type="radio" id="radio1_8" name="radios" value="0">
								  <label for="radio1_8">Brazil<br><font size="6">2,1</font></label>

								  <input type="radio" id="radio2_8" name="radios" value="1">
								  <label for="radio2_8">~<br><font size="6">3,3</font></label>

								  <input type="radio" id="radio3_8" name="radios" value="2">
								  <label for="radio3_8">Belgium<br><font size="6">3,7</font></label>
								  
								  <input type="number" name="pointInput" placeholder="0">
								  <input type="submit" value="SAVE">
								</div>	
							</form>
						</div>
						<div class="tipp-form">
							<form id="Uruguay_France">
								<div class="btn-group">
								  <input type="radio" id="radio1_7" name="radios" value="0">
								  <label for="radio1_7">Uruguay<br><font size="6">4,4</font></label>

								  <input type="radio" id="radio2_7" name="radios" value="1">
								  <label for="radio2_7">~<br><font size="6">3,2</font></label>

								  <input type="radio" id="radio3_7" name="radios" value="2">
								  <label for="radio3_7">France<br><font size="6">1,95</font></label>
								  
								  <input type="number" name="pointInput" placeholder="0">
								  <input type="submit" value="SAVE">
								</div>	
							</form>
						</div>
						<div class="tipp-form">
							<form id="Colombia_England">
								<div class="btn-group">
								  <input type="radio" id="radio1_6" name="radios" value="0">
								  <label for="radio1_6">Colombia<br><font size="6">4,0</font></label>

								  <input type="radio" id="radio2_6" name="radios" value="1">
								  <label for="radio2_6">~<br><font size="6">3,2</font></label>

								  <input type="radio" id="radio3_6" name="radios" value="2">
								  <label for="radio3_6">England<br><font size="6">2,05</font></label>
								  
								  <input type="number" name="pointInput" placeholder="0">
								  <input type="submit" value="SAVE">
								</div>	
							</form>
						</div>
						<div class="tipp-form">
							<form id="Sweden_Switzerland">
								<div class="btn-group">
								  <input type="radio" id="radio1_5" name="radios" value="0">
								  <label for="radio1_5">Sweden<br><font size="6">3,0</font></label>

								  <input type="radio" id="radio2_5" name="radios" value="1">
								  <label for="radio2_5">~<br><font size="6">2,9</font></label>

								  <input type="radio" id="radio3_5" name="radios" value="2">
								  <label for="radio3_5">Switzerland<br><font size="6">2,7</font></label>
								  
								  <input type="number" name="pointInput" placeholder="0">
								  <input type="submit" value="SAVE">
								</div>	
							</form>
						</div>
						<div class="tipp-form">
							<form id="Belgium_Japan">
								<div class="btn-group">
								  <input type="radio" id="radio1_4" name="radios" value="0">
								  <label for="radio1_4">Belgium<br><font size="6">1,37</font></label>

								  <input type="radio" id="radio2_4" name="radios" value="1">
								  <label for="radio2_4">~<br><font size="6">4,6</font></label>

								  <input type="radio" id="radio3_4" name="radios" value="2">
								  <label for="radio3_4">Japan<br><font size="6">10,0</font></label>
								  
								  <input type="number" name="pointInput" placeholder="0">
								  <input type="submit" value="SAVE">
								</div>	
							</form>
						</div>
						<div class="tipp-form">
							<form id="Brazil_Mexico">
								<div class="btn-group">
								  <input type="radio" id="radio1_3" name="radios" value="0">
								  <label for="radio1_3">Brazil<br><font size="6">1,45</font></label>

								  <input type="radio" id="radio2_3" name="radios" value="1">
								  <label for="radio2_3">~<br><font size="6">4,3</font></label>

								  <input type="radio" id="radio3_3" name="radios" value="2">
								  <label for="radio3_3">Mexico<br><font size="6">8,0</font></label>
								  
								  <input type="number" name="pointInput" placeholder="0">
								  <input type="submit" value="SAVE">
								</div>	
							</form>
						</div>
						<div class="tipp-form">
							<form id="Croatia_Denmark">
								<div class="btn-group">
								  <input type="radio" id="radio1_2" name="radios" value="0">
								  <label for="radio1_2">Croatia<br><font size="6">1,9</font></label>

								  <input type="radio" id="radio2_2" name="radios" value="1">
								  <label for="radio2_2">~<br><font size="6">3,2</font></label>

								  <input type="radio" id="radio3_2" name="radios" value="2">
								  <label for="radio3_2">Denmark<br><font size="6">4,7</font></label>
								  
								  <input type="number" name="pointInput" placeholder="0">
								  <input type="submit" value="SAVE">
								</div>	
							</form>
						</div>
						<div class="tipp-form">
							<form id="Spain_Russia">
								<div class="btn-group">
								  <input type="radio" id="radio1_1" name="radios" value="0">
								  <label for="radio1_1">Spain<br><font size="6">1,55</font></label>

								  <input type="radio" id="radio2_1" name="radios" value="1">
								  <label for="radio2_1">~<br><font size="6">4,1</font></label>

								  <input type="radio" id="radio3_1" name="radios" value="2">
								  <label for="radio3_1">Russia<br><font size="6">6,3</font></label>
								  
								  <input type="number" name="pointInput" placeholder="0">
								  <input type="submit" value="SAVE">
								</div>	
							</form>
						</div>
					</div>
					<div id="points">
					</div>
				</div>
			</div>
		</div>
    <script src="/scripts/socket.io-1.2.0.js"></script>
    <script src="/scripts/jquery-1.11.1.js"></script>
	<script> 
		var myID = "";
		var myChips = 0;
		var map;
		var matches;
		var users;
	
		const getCookie = (name) => {
		  const value = "; " + document.cookie;
		  const parts = value.split("; " + name + "=");
		  if (parts.length === 2) return parts.pop().split(";").shift();
		};

		const deleteCookie = (name) => {
		  document.cookie = name + '=; max-age=0;';
		};

		const parseObjectFromCookie = (cookie) => {
		  const decodedCookie = decodeURIComponent(cookie);
		  return JSON.parse(decodedCookie);
		};

		window.onload = () => {
		  let dataCookie = getCookie('data');
		  deleteCookie('data');

		  if (dataCookie) {
			const data = parseObjectFromCookie(dataCookie);
			//data is all data from logged in user
			//console.log(data);
			myID = data["username"];
			myChips = data["points"];
			$('#pointView').text("Chips: " + myChips);
			map = data["tipps"];
			for (var key in map) {
				var value = map[key];
				//console.log(key + ": " + value.value + ", " + value.choice);
				$('#'+key).find('input[name="pointInput"]').val(value.value);
				$('#'+key).find('input[name=radios][value='+value.choice+']').prop("checked", true);
			}

			
		  } else {
			// handle data not found
		  }
		}
		
		getMatches();
		setInterval(getMatches, 120000);
		
		function getMatches() {
			fetch('/clicks', {method: 'GET'})
			.then(function(response) {
			  if(response.ok) return response.json();
			  throw new Error('Request failed.');
			})
			.then(function(data) {
				//check games if already playing or ...
				matches = data.games;
				users = data.users;
				
				for(var i=0; i<matches.length; i++) {
					if(matches[i].state != "SCHEDULED") {
						$('#' + matches[i].id).find('input[name="pointInput"]').prop("disabled",true);
						$('#' + matches[i].id).find('input[type="submit"]').prop("disabled",true);
						$('#' + matches[i].id).find('input[name=radios]').prop("disabled",true);
					}
				}
				
				//create table
				var content = "<table cellspacing='10'>"
				content += "<tr><th>User</th><th style='padding-left:25px'>Score</th></tr>";
				for(var i=0; i<users.length; i++) {
					var username = users[i].username;
					var points = users[i].points;
					content += '<tr><td>' + username + "</td><td style='padding-left:25px'>" + points + '</td></tr>';

				}
				content += "</table>"
				$('#points').html(content);
			})
			.catch(function(error) {
			  console.log(error);
			});
		}
		
		$(function() {
			//save new Chip-Value to DB and local map
			$('form').submit(function() {
				var gameID = $(this).closest("form[id]").attr('id');
				console.log("form id: " + gameID);

				var chips = $('#'+gameID).find('input[name="pointInput"]').val();
				var checkedValue = $('#'+gameID).find('input[name=radios]:checked').val();
				if(checkedValue == undefined) {
					//stop if no team selected
					alert("You have to select a team!");
					return false;
				}
				if(chips == undefined) {
					//stop if no chips bet
					alert("You have to select a team!");
					return false;
				}
				if(map[gameID] != undefined) {
					var old = map[gameID].value;
					var diffToOld = chips-old;
					if(diffToOld > myChips) {
						//stop if not enough chips
						alert("You dont have that much chips!");
						return false;
					}
					map[gameID].value = chips;
					map[gameID].choice = checkedValue;
					myChips = myChips - diffToOld;
				} else {
					var diffToOld = chips;
					if(diffToOld > myChips) {
						//stop if not enough chips
						alert("You dont have that much chips!");
						return false;
					}
					map[gameID] = {"value": +chips, "choice": +checkedValue};
					myChips = myChips - diffToOld;
				}
				//disable buttons for 5seconds
				for(var i=0; i<matches.length; i++) {
					if(matches[i].state == "SCHEDULED") {
						$('#' + matches[i].id).find('input[type="submit"]').prop("disabled",true);
					}
				}
				$('#pointView').text("Chips: " + myChips);						
				
				$.ajax({
					type: 'POST',
					url: '/clicked',
					data: {myID, chips, checkedValue, gameID, diffToOld}
				});
				
				//enable buttons after 5seconds, show countdown
				var count = 4;
				var interval = setInterval(function(){
					if(count == 0) {
						for(var i=0; i<matches.length; i++) {
							if(matches[i].state == "SCHEDULED") {
								$('#' + matches[i].id).find('input[type="submit"]').prop("disabled",false);
								$('#' + matches[i].id).find('input[type="submit"]').prop('value', 'SAVE');
							}
						}
						clearInterval(interval);
					} else {
						for(var i=0; i<matches.length; i++) {
							if(matches[i].state == "SCHEDULED") {
								$('#' + matches[i].id).find('input[type="submit"]').prop('value', count);
							}
						}
					}
					count--;
				},1000);
				
				return false;
			}); 
		})
	</script>
  </body>
</html>